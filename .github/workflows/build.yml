name: build-android-arm64

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      ANDROID_PLATFORM: "31"
      NDK_VERSION: "r25b"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install base deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            cmake \
            ninja-build \
            zstd \
            python3-pip \
            wget \
            git \
            build-essential \
            clang \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            libc6-dev-arm64-cross \
            pkg-config
          pip3 install --upgrade pip

      - name: Setup Android NDK r25b
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: Export NDK path
        run: echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

      - name: Ensure glslc (shaderc) is available
        run: |
          if command -v glslc >/dev/null 2>&1; then glslc --version; else
            sudo apt-get install -y shaderc-tools || true
            if ! command -v glslc >/dev/null 2>&1; then
              wget -qO /tmp/glslc https://sdk.lunarg.com/sdk/download/1.3.261.1/linux/x86_64/glslc || true
              chmod +x /tmp/glslc || true
              sudo mv /tmp/glslc /usr/local/bin/glslc || true
            fi
            glslc --version || true
          fi

      - name: Configure build (Android arm64)
        run: |
          mkdir -p build
          cmake -S . -B build -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE="${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=${{ env.ANDROID_PLATFORM }} \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -j

      - name: Precompile BCn fallback shader
        run: |
          mkdir -p build/shaders
          if command -v glslc >/dev/null 2>&1; then
            glslc src/bc_decode_comp.comp -o build/shaders/bc_decode_comp.spv
            mkdir -p pkg/assets/shaders
            cp build/shaders/bc_decode_comp.spv pkg/assets/shaders/
          else
            echo "glslc not available; skipping shader precompile"
          fi

      - name: Install to pkg
        run: cmake --install build --prefix "$(pwd)/pkg"

      - name: Validate artifact
        run: |
          python3 tools/validate.py pkg/usr/lib/libvulkan.so icd_manifest.json

      - name: Package driver folder
        run: |
          python3 tools/package.py pkg xclipse940-driver.tar.zst

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xclipse940-driver
          path: xclipse940-driver.tar.zst
